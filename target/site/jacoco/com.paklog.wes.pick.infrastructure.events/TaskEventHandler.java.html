<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaskEventHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pick-execution-service</a> &gt; <a href="index.source.html" class="el_package">com.paklog.wes.pick.infrastructure.events</a> &gt; <span class="el_source">TaskEventHandler.java</span></div><h1>TaskEventHandler.java</h1><pre class="source lang-java linenums">package com.paklog.wes.pick.infrastructure.events;

import com.paklog.domain.valueobject.Priority;
import com.paklog.wes.pick.application.command.StartPickSessionCommand;
import com.paklog.wes.pick.application.service.PickSessionService;
import com.paklog.wes.pick.domain.aggregate.PickSession;
import com.paklog.wes.pick.domain.entity.PickInstruction;
import com.paklog.wes.pick.domain.valueobject.Location;
import com.paklog.wes.pick.domain.valueobject.PickStrategy;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Objects;

/**
 * Event handler for Task events
 * Listens to task-related events and creates pick sessions
 */
@Component
public class TaskEventHandler {

<span class="fc" id="L27">    private static final Logger logger = LoggerFactory.getLogger(TaskEventHandler.class);</span>

    private final PickSessionService pickSessionService;

<span class="fc" id="L31">    public TaskEventHandler(PickSessionService pickSessionService) {</span>
<span class="fc" id="L32">        this.pickSessionService = pickSessionService;</span>
<span class="fc" id="L33">    }</span>

    /**
     * Handle TaskCreatedEvent from task-execution-service
     * Creates pick sessions for PICK tasks
     */
    @KafkaListener(
            topics = &quot;${paklog.kafka.topics.task-events:wes-task-events}&quot;,
            groupId = &quot;${paklog.kafka.consumer.group-id:pick-execution-service}&quot;
    )
    public void handleTaskCreated(Map&lt;String, Object&gt; eventData) {
        try {
<span class="fc" id="L45">            String eventType = (String) eventData.get(&quot;type&quot;);</span>

<span class="pc bpc" id="L47" title="1 of 2 branches missed.">            if (!&quot;TaskCreatedEvent&quot;.equals(eventType)) {</span>
<span class="nc" id="L48">                return; // Ignore other event types</span>
            }

<span class="fc" id="L51">            String taskType = (String) eventData.get(&quot;taskType&quot;);</span>
<span class="fc bfc" id="L52" title="All 2 branches covered.">            if (!&quot;PICK&quot;.equals(taskType)) {</span>
<span class="fc" id="L53">                return; // Only handle PICK tasks</span>
            }

<span class="fc" id="L56">            logger.info(&quot;Received TaskCreatedEvent for PICK task: {}&quot;, eventData);</span>

<span class="fc" id="L58">            String taskId = (String) eventData.get(&quot;taskId&quot;);</span>
<span class="fc" id="L59">            String warehouseId = (String) eventData.get(&quot;warehouseId&quot;);</span>
<span class="fc" id="L60">            String referenceId = (String) eventData.get(&quot;referenceId&quot;); // Wave ID</span>

            @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L63">            Map&lt;String, Object&gt; context = (Map&lt;String, Object&gt;) eventData.get(&quot;context&quot;);</span>

            // Create pick session for this task
<span class="fc" id="L66">            createPickSession(taskId, warehouseId, referenceId, context);</span>

<span class="fc" id="L68">            logger.info(&quot;Created pick session for task {}&quot;, taskId);</span>

<span class="nc" id="L70">        } catch (Exception e) {</span>
<span class="nc" id="L71">            logger.error(&quot;Error handling TaskCreatedEvent&quot;, e);</span>
            // In production, publish to dead letter queue
<span class="fc" id="L73">        }</span>
<span class="fc" id="L74">    }</span>

    private void createPickSession(String taskId,
                                   String warehouseId,
                                   String waveId,
                                   Map&lt;String, Object&gt; context) {
<span class="fc bfc" id="L80" title="All 2 branches covered.">        if (context == null) {</span>
<span class="fc" id="L81">            logger.warn(&quot;Ignoring task {} creation event - missing context payload&quot;, taskId);</span>
<span class="fc" id="L82">            return;</span>
        }

        try {
<span class="fc" id="L86">            PickStrategy strategy = parseStrategy(context.get(&quot;strategy&quot;));</span>
<span class="fc" id="L87">            List&lt;PickInstruction&gt; instructions = extractPickInstructions(context);</span>

<span class="fc bfc" id="L89" title="All 2 branches covered.">            if (instructions.isEmpty()) {</span>
<span class="fc" id="L90">                logger.warn(&quot;Ignoring task {} creation event - no pick instructions provided&quot;, taskId);</span>
<span class="fc" id="L91">                return;</span>
            }

<span class="fc" id="L94">            String workerId = stringValue(context.get(&quot;workerId&quot;), &quot;UNASSIGNED&quot;);</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">            String cartId = stringValue(context.get(&quot;cartId&quot;), waveId != null ? waveId : &quot;SYSTEM-CART&quot;);</span>

<span class="fc" id="L97">            StartPickSessionCommand command = new StartPickSessionCommand(</span>
                    taskId,
                    workerId,
                    warehouseId,
                    strategy,
                    cartId,
                    instructions
            );

<span class="fc" id="L106">            PickSession session = pickSessionService.createSession(command);</span>

<span class="fc" id="L108">            logger.debug(&quot;Created pick session {} for task {} using strategy {}&quot;,</span>
<span class="fc" id="L109">                    session.getSessionId(), taskId, strategy);</span>

<span class="nc" id="L111">        } catch (Exception e) {</span>
<span class="nc" id="L112">            logger.error(&quot;Error creating pick session for task {}&quot;, taskId, e);</span>
<span class="fc" id="L113">        }</span>
<span class="fc" id="L114">    }</span>

    /**
     * Handle TaskAssignedEvent from task-execution-service
     * Notifies picker of new assignment
     */
    @KafkaListener(
            topics = &quot;${paklog.kafka.topics.task-events:wes-task-events}&quot;,
            groupId = &quot;${paklog.kafka.consumer.group-id:pick-execution-service}&quot;
    )
    public void handleTaskAssigned(Map&lt;String, Object&gt; eventData) {
        try {
<span class="fc" id="L126">            String eventType = (String) eventData.get(&quot;type&quot;);</span>

<span class="pc bpc" id="L128" title="1 of 2 branches missed.">            if (!&quot;TaskAssignedEvent&quot;.equals(eventType)) {</span>
<span class="nc" id="L129">                return;</span>
            }

<span class="fc" id="L132">            String taskType = (String) eventData.get(&quot;taskType&quot;);</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">            if (!&quot;PICK&quot;.equals(taskType)) {</span>
<span class="nc" id="L134">                return;</span>
            }

<span class="fc" id="L137">            logger.info(&quot;Received TaskAssignedEvent for PICK task: {}&quot;, eventData);</span>

<span class="fc" id="L139">            String taskId = (String) eventData.get(&quot;taskId&quot;);</span>
<span class="fc" id="L140">            String assignedTo = (String) eventData.get(&quot;assignedTo&quot;);</span>

<span class="pc bpc" id="L142" title="1 of 4 branches missed.">            if (assignedTo == null || assignedTo.isBlank()) {</span>
<span class="fc" id="L143">                logger.warn(&quot;Ignoring TaskAssignedEvent for task {} - missing assigned picker&quot;, taskId);</span>
<span class="fc" id="L144">                return;</span>
            }

<span class="fc" id="L147">            boolean sessionExists = pickSessionService.getActiveSessions().stream()</span>
<span class="fc" id="L148">                    .anyMatch(session -&gt; Objects.equals(session.getTaskId(), taskId));</span>

<span class="pc bpc" id="L150" title="1 of 2 branches missed.">            if (sessionExists) {</span>
<span class="fc" id="L151">                logger.info(&quot;Picker {} assigned to pick session for task {}&quot;, assignedTo, taskId);</span>
            } else {
<span class="nc" id="L153">                logger.warn(&quot;No active pick session found for task {} when assigning picker {}&quot;, taskId, assignedTo);</span>
            }

<span class="nc" id="L156">        } catch (Exception e) {</span>
<span class="nc" id="L157">            logger.error(&quot;Error handling TaskAssignedEvent&quot;, e);</span>
<span class="fc" id="L158">        }</span>
<span class="fc" id="L159">    }</span>

    private PickStrategy parseStrategy(Object rawStrategy) {
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if (rawStrategy instanceof PickStrategy strategy) {</span>
<span class="nc" id="L163">            return strategy;</span>
        }

<span class="pc bpc" id="L166" title="2 of 4 branches missed.">        if (rawStrategy instanceof String strategyName &amp;&amp; !strategyName.isBlank()) {</span>
            try {
<span class="fc" id="L168">                return PickStrategy.valueOf(strategyName.toUpperCase());</span>
<span class="fc" id="L169">            } catch (IllegalArgumentException ex) {</span>
<span class="fc" id="L170">                logger.warn(&quot;Unknown pick strategy '{}', falling back to SINGLE&quot;, strategyName);</span>
            }
        }

<span class="fc" id="L174">        return PickStrategy.SINGLE;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private List&lt;PickInstruction&gt; extractPickInstructions(Map&lt;String, Object&gt; context) {
<span class="fc" id="L179">        Object rawInstructions = context.get(&quot;instructions&quot;);</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        if (!(rawInstructions instanceof Iterable&lt;?&gt; iterable)) {</span>
<span class="nc" id="L181">            return List.of();</span>
        }

<span class="fc" id="L184">        List&lt;PickInstruction&gt; instructions = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">        for (Object raw : iterable) {</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">            if (!(raw instanceof Map&lt;?, ?&gt; instructionMap)) {</span>
                continue;
            }

<span class="fc" id="L190">            String instructionId = stringValue(instructionMap.get(&quot;instructionId&quot;), null);</span>
<span class="fc" id="L191">            String sku = stringValue(instructionMap.get(&quot;itemSku&quot;), null);</span>
<span class="fc" id="L192">            Number quantityValue = asNumber(instructionMap.get(&quot;expectedQuantity&quot;));</span>

<span class="fc" id="L194">            Location location = buildLocation(instructionMap.get(&quot;location&quot;));</span>

<span class="pc bpc" id="L196" title="3 of 8 branches missed.">            if (instructionId == null || sku == null || quantityValue == null || location == null) {</span>
<span class="fc" id="L197">                logger.warn(&quot;Skipping instruction due to missing required fields: {}&quot;, instructionMap);</span>
<span class="fc" id="L198">                continue;</span>
            }

<span class="fc" id="L201">            int expectedQuantity = quantityValue.intValue();</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">            if (expectedQuantity &lt;= 0) {</span>
<span class="nc" id="L203">                logger.warn(&quot;Skipping instruction {} due to invalid quantity {}&quot;, instructionId, expectedQuantity);</span>
<span class="nc" id="L204">                continue;</span>
            }

<span class="fc" id="L207">            String description = stringValue(instructionMap.get(&quot;itemDescription&quot;), null);</span>
<span class="fc" id="L208">            String orderId = stringValue(instructionMap.get(&quot;orderId&quot;), null);</span>
<span class="fc" id="L209">            Priority priority = parsePriority(instructionMap.get(&quot;priority&quot;));</span>

<span class="fc" id="L211">            PickInstruction instruction = new PickInstruction(</span>
                    instructionId,
                    sku,
                    description,
                    expectedQuantity,
                    location,
                    orderId,
                    priority
            );

<span class="fc" id="L221">            instructions.add(instruction);</span>
<span class="fc" id="L222">        }</span>

<span class="fc" id="L224">        return instructions;</span>
    }

    private Priority parsePriority(Object rawPriority) {
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">        if (rawPriority instanceof Priority priority) {</span>
<span class="nc" id="L229">            return priority;</span>
        }

<span class="pc bpc" id="L232" title="2 of 4 branches missed.">        if (rawPriority instanceof String priorityName &amp;&amp; !priorityName.isBlank()) {</span>
            try {
<span class="fc" id="L234">                return Priority.valueOf(priorityName.toUpperCase());</span>
<span class="fc" id="L235">            } catch (IllegalArgumentException ex) {</span>
<span class="fc" id="L236">                logger.warn(&quot;Unknown priority '{}', defaulting to NORMAL&quot;, priorityName);</span>
            }
        }

<span class="fc" id="L240">        return Priority.NORMAL;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private Location buildLocation(Object rawLocation) {
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        if (!(rawLocation instanceof Map&lt;?, ?&gt; locationMap)) {</span>
<span class="nc" id="L246">            return null;</span>
        }

<span class="fc" id="L249">        String aisle = stringValue(locationMap.get(&quot;aisle&quot;), null);</span>
<span class="fc" id="L250">        String bay = stringValue(locationMap.get(&quot;bay&quot;), null);</span>
<span class="fc" id="L251">        String level = stringValue(locationMap.get(&quot;level&quot;), null);</span>
<span class="fc" id="L252">        String position = stringValue(locationMap.get(&quot;position&quot;), null);</span>

<span class="pc bpc" id="L254" title="2 of 6 branches missed.">        if (aisle == null || bay == null || level == null) {</span>
<span class="fc" id="L255">            return null;</span>
        }

<span class="fc" id="L258">        return new Location(aisle, bay, level, position);</span>
    }

    private Number asNumber(Object value) {
<span class="fc bfc" id="L262" title="All 2 branches covered.">        if (value instanceof Number number) {</span>
<span class="fc" id="L263">            return number;</span>
        }

<span class="pc bpc" id="L266" title="2 of 4 branches missed.">        if (value instanceof String text &amp;&amp; !text.isBlank()) {</span>
            try {
<span class="fc" id="L268">                return Integer.parseInt(text.trim());</span>
<span class="nc" id="L269">            } catch (NumberFormatException ex) {</span>
<span class="nc" id="L270">                logger.warn(&quot;Unable to parse numeric value '{}'&quot;, text);</span>
            }
        }

<span class="nc" id="L274">        return null;</span>
    }

    private String stringValue(Object value, String defaultValue) {
<span class="fc bfc" id="L278" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L279">            return defaultValue;</span>
        }
<span class="fc" id="L281">        String text = Objects.toString(value, defaultValue);</span>
<span class="pc bpc" id="L282" title="1 of 4 branches missed.">        return text != null &amp;&amp; !text.isBlank() ? text : defaultValue;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>